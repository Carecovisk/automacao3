<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Ctrl+A Parser com SheetJS</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f0f2f5; }
        .instructions {
            background: #fff; padding: 20px; border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px;
        }
        #status { color: #666; font-style: italic; margin-top: 10px; }
        pre { background: #2d2d2d; color: #a9b7c6; padding: 15px; border-radius: 5px; overflow: auto; max-height: 500px; }
    </style>
</head>
<body>

    <div class="instructions">
        <h2>Passo a Passo:</h2>
        <ol>
            <li>Vá ao site da secretaria e abra uma pesquisa de mercado.</li>
            <li>Dê <b>Ctrl + A</b> (selecionar tudo) e <b>Ctrl + C</b>.</li>
            <li>Clique nesta página e dê <b>Ctrl + V</b>.</li>
        </ol>
        <div id="status">Aguardando colagem...</div>
    </div>

    <h3>Dados Extraídos (Da maior tabela encontrada):</h3>
    <pre id="output">{}</pre>

    <script>
        document.addEventListener('paste', function(e) {
            e.preventDefault();
            const statusDiv = document.getElementById('status');
            
            // 1. Pega o HTML sujo (pagina inteira)
            const clipboardHTML = e.clipboardData.getData('text/html');
            if (!clipboardHTML) {
                statusDiv.textContent = "Erro: Nenhum HTML encontrado. Você copiou do site da secretaria?";
                return;
            }

            statusDiv.textContent = "Processando dados...";

            // 2. Parser do HTML na memória
            const parser = new DOMParser();
            const doc = parser.parseFromString(clipboardHTML, "text/html");
            console.log("Documento colado:", doc);

            // 3. Encontra conteudo relevante
            const content = doc.getElementById('conteudo') 
            const description = doc.querySelector('html body div#pagina table tbody tr td table tbody tr td table tbody tr td table tbody tr td div#conteudo fieldset strong form table tbody tr td strong')
                                    ?.textContent.trim() || "Sem descrição disponível.";
            console.log("Descrição da tabela:", description);

            const bestTable = doc.querySelector('html body div#pagina table tbody tr td table tbody tr td table tbody tr td table tbody tr td div#conteudo fieldset strong form table:nth-of-type(2)');
            const maxRows = bestTable ? bestTable?.rows?.length : 0;
            

            statusDiv.textContent = `Sucesso! Extraída a tabela com ${maxRows} linhas.`;
            // 5. Converte a "Melhor Tabela" usando SheetJS
            const workbook = XLSX.utils.table_to_book(bestTable, { raw: true });
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            
            console.log(worksheet);
            // Gera o JSON
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 }); // header:1 traz array de arrays
            
            document.getElementById('output').textContent = JSON.stringify(jsonData, null, 2);

        });
    </script>

</body>
</html>